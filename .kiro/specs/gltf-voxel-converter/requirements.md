# 要件定義: gltf-voxel-converter

## プロジェクト概要

GLB/GLTF形式の3DモデルをボクセルデータへVariableし、Blockbench用Minecraftリソースパック形式で出力するサーバーレスWebアプリケーション。

### ユーザーフロー
1. GLB/GLTFファイルを用意
2. サイトにファイルをドラッグ&ドロップ（クライアントサイドのみで処理）
3. ボクセル解像度を指定してボクセル化
4. 3Dプレビューで確認・調整
5. Blockbench形式でダウンロード

### 技術構成
- React + TypeScript
- Vite（ビルドツール）
- Vitest（テストフレームワーク）

---

## 技術仕様調査まとめ

### GLB/GLTF仕様

**フォーマット概要**
- glTF 2.0はKhronos Groupが策定した3Dアセット配信フォーマット（ISO/IEC 12113:2022）
- 「3DのJPEG」と呼ばれ、WebGLやゲームエンジンで広くサポート

**ファイル形式**
| 形式 | 拡張子 | MIME Type | 特徴 |
|------|--------|-----------|------|
| JSON glTF | `.gltf` | `model/gltf+json` | 人間が読めるJSON + 外部バイナリ/テクスチャ |
| Binary glTF | `.glb` | `model/gltf-binary` | 単一ファイルにすべて内包 |

**GLBバイナリ構造**
- 12バイトヘッダー（magic: 0x46546C67、version、length）
- チャンク構造: JSON チャンク + BIN チャンク
- リトルエンディアン、4バイトアライメント

**主要な構成要素**
- `scenes` / `nodes`: シーングラフ構造
- `meshes`: ジオメトリデータ（頂点、法線、UV）
- `materials`: PBRマテリアル定義
- `textures` / `images`: テクスチャ画像
- `buffers` / `bufferViews` / `accessors`: バイナリデータ参照

### Minecraft/Blockbench モデル形式

**Java Block/Item Model形式（.json）**

```json
{
  "parent": "minecraft:block/cube_all",
  "textures": {
    "all": "minecraft:block/stone"
  },
  "elements": [
    {
      "from": [0, 0, 0],
      "to": [16, 16, 16],
      "faces": {
        "down":  {"uv": [0, 0, 16, 16], "texture": "#all"},
        "up":    {"uv": [0, 0, 16, 16], "texture": "#all"},
        "north": {"uv": [0, 0, 16, 16], "texture": "#all"},
        "south": {"uv": [0, 0, 16, 16], "texture": "#all"},
        "west":  {"uv": [0, 0, 16, 16], "texture": "#all"},
        "east":  {"uv": [0, 0, 16, 16], "texture": "#all"}
      }
    }
  ],
  "display": {
    "gui": {"rotation": [30, 225, 0], "translation": [0, 0, 0], "scale": [0.625, 0.625, 0.625]}
  }
}
```

**主要プロパティ**
| プロパティ | 説明 |
|-----------|------|
| `parent` | 継承元モデル |
| `textures` | テクスチャ変数定義 |
| `elements` | 立方体要素の配列 |
| `display` | 各表示コンテキストの設定 |

**elements詳細**
- `from` / `to`: 立方体の始点・終点（-16〜32）
- `rotation`: 回転（origin, axis, angle: 22.5°刻み）
- `faces`: 各面の設定（down, up, north, south, west, east）
  - `uv`: テクスチャ座標 [x1, y1, x2, y2]（0〜16）
  - `texture`: `#変数名`形式でテクスチャ参照
  - `cullface`: カリング方向
  - `rotation`: テクスチャ回転（0/90/180/270）
  - `tintindex`: 色付けインデックス

**制約事項**
- 要素は立方体のみ
- 回転は1軸のみ、22.5°刻み
- 座標範囲: -16〜32

### ボクセル化アルゴリズム

**基本アプローチ**
1. **レイキャスト法**: 各ボクセル中心から光線を飛ばしメッシュとの交差判定
2. **サーフェスボクセル化**: メッシュ表面のみをボクセル化
3. **ボリュームボクセル化**: 内部も含めて充填

**色サンプリング**
- ボクセル内の複数サンプル点の色を平均化
- テクスチャUV座標から色を取得
- マテリアルの基本色（baseColorFactor）を使用

**利用可能なライブラリ**
- **voxelizer** (npm): three.jsベースのボクセル化エンジン
- **three.js GLTFLoader**: GLB/GLTFのパース

---

## 要件一覧

### 1. ファイル入力機能

**FR-1.1: GLB/GLTFファイル読み込み**
> システムは、ユーザーがGLB形式またはGLTF形式の3Dモデルファイルをアップロードした場合、ファイルをクライアントサイドで読み込み、メモリ上に保持しなければならない。

受け入れ基準:
- [ ] ドラッグ&ドロップでファイルを受け付ける
- [ ] ファイル選択ダイアログからも選択可能
- [ ] .glb拡張子のファイルを正しくパースできる
- [ ] .gltf拡張子のファイル（外部バイナリなし）を正しくパースできる
- [ ] 不正なファイル形式の場合、エラーメッセージを表示する

**FR-1.2: サーバーレス処理**
> システムは、すべての処理をクライアントサイド（ブラウザ内）で完結し、外部サーバーへのファイル送信を行わないこと。

受け入れ基準:
- [ ] ネットワークリクエストでファイルデータが送信されない
- [ ] オフライン環境でも動作する（初回ロード後）

### 2. ボクセル化機能

**FR-2.1: ボクセル解像度設定**
> システムは、ユーザーがボクセル解像度（グリッド数）を指定した場合、指定された解像度でモデルをボクセル化しなければならない。

受け入れ基準:
- [ ] 解像度を数値入力またはスライダーで指定できる
- [ ] 最小解像度: 8
- [ ] 最大解像度: 64（パフォーマンス考慮）
- [ ] デフォルト解像度: 16

**FR-2.2: テクスチャからの色抽出**
> システムは、モデルにテクスチャが含まれる場合、各ボクセル位置に対応するテクスチャの色をサンプリングし、ボクセルの色として割り当てなければならない。

受け入れ基準:
- [ ] テクスチャ付きモデルの場合、UV座標から色を取得
- [ ] テクスチャなしモデルの場合、マテリアルの基本色を使用
- [ ] 複数テクスチャを持つモデルに対応

**FR-2.3: ジオメトリのボクセル化**
> システムは、3Dメッシュのジオメトリをボクセルグリッドに変換し、元の形状を近似的に再現しなければならない。

受け入れ基準:
- [ ] メッシュの表面をボクセル化できる
- [ ] 空中に浮いたボクセルが発生しない（連続性の維持）
- [ ] 変換処理中に進捗状況を表示する

### 3. プレビュー機能

**FR-3.1: 3Dプレビュー表示**
> システムは、ボクセル化が完了した場合、結果を3Dビューワーで表示しなければならない。

受け入れ基準:
- [ ] ボクセル化されたモデルを3D表示
- [ ] マウスドラッグで回転操作が可能
- [ ] スクロールでズームイン/アウトが可能
- [ ] 各ボクセルの色が正しく表示される

**FR-3.2: リアルタイムパラメータ調整**
> システムは、ユーザーがボクセル解像度を変更した場合、プレビューをリアルタイムで更新しなければならない。

受け入れ基準:
- [ ] 解像度変更後、自動的に再ボクセル化
- [ ] 変換中はローディング表示
- [ ] 前の結果と比較可能

### 4. エクスポート機能

**FR-4.1: Blockbench形式出力**
> システムは、ユーザーが「出力」を選択した場合、ボクセルデータをBlockbenchで読み込み可能なJava Block/Item Model形式（.json）に変換しなければならない。

受け入れ基準:
- [ ] 出力ファイルがBlockbenchで正常に開ける
- [ ] 各ボクセルが1つのelement（立方体）として出力される
- [ ] 座標が-16〜32の範囲に正規化される
- [ ] 面のUVが正しく設定される

**FR-4.2: テクスチャ出力**
> システムは、ボクセルの色情報をテクスチャ画像として出力し、モデルJSONから参照できるようにしなければならない。

受け入れ基準:
- [ ] テクスチャ画像（PNG）が生成される
- [ ] モデルJSONのtextures定義が正しい
- [ ] 各ボクセル面のUVがテクスチャの正しい位置を参照

**FR-4.3: ファイルダウンロード**
> システムは、変換されたファイルをZIPアーカイブとしてダウンロード提供しなければならない。

受け入れ基準:
- [ ] ZIPファイルとしてダウンロードできる
- [ ] ZIP内にmodel.jsonとtexture.pngが含まれる
- [ ] ファイル名をカスタマイズ可能

### 5. UI/UX要件

**FR-5.1: レスポンシブデザイン**
> システムは、デスクトップブラウザおよびタブレットで適切に表示されなければならない。

受け入れ基準:
- [ ] 最小幅768pxで適切にレイアウト
- [ ] 主要ブラウザ（Chrome、Firefox、Safari、Edge）で動作

**FR-5.2: エラーハンドリング**
> システムは、エラーが発生した場合、ユーザーに理解可能なエラーメッセージを表示しなければならない。

受け入れ基準:
- [ ] ファイル形式エラー時にメッセージ表示
- [ ] 変換エラー時に原因を説明
- [ ] エラー状態から復帰可能

### 6. パフォーマンス要件

**NFR-6.1: 変換速度**
> システムは、標準的なモデル（10,000ポリゴン以下）を解像度16で変換する場合、5秒以内に完了しなければならない。

受け入れ基準:
- [ ] ベンチマークテストで5秒以内を確認
- [ ] 大きなモデルの場合は進捗表示

**NFR-6.2: メモリ使用量**
> システムは、変換処理中のメモリ使用量を1GB以下に抑えなければならない。

受け入れ基準:
- [ ] Chrome DevToolsでメモリ使用量を計測
- [ ] メモリリークがないことを確認

---

## 出典・参考資料

- [glTF™ 2.0 Specification](https://registry.khronos.org/glTF/specs/2.0/glTF-2.0.html)
- [glTF - Wikipedia](https://en.wikipedia.org/wiki/GlTF)
- [Model – Minecraft Wiki](https://minecraft.wiki/w/Model)
- [Formats - Blockbench Wiki](https://www.blockbench.net/wiki/blockbench/formats/)
- [voxelizer - npm](https://www.npmjs.com/package/voxelizer)
- [GLTFLoader - Three.js Docs](https://threejs.org/docs/pages/GLTFLoader.html)
- [How to Voxelize Meshes and Point Clouds in Python](https://towardsdatascience.com/how-to-voxelize-meshes-and-point-clouds-in-python-ca94d403f81d/)
