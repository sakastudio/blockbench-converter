# 実装タスク: gltf-voxel-converter

## タスク概要

| 項目 | 値 |
|------|-----|
| 総メジャータスク数 | 10 |
| 総サブタスク数 | 26 |
| 対応要件数 | 14 |
| 推定作業時間 | 各サブタスク1-3時間 |

---

## タスク一覧

### 1. プロジェクト初期化とビルド環境構築

Vite + React + TypeScriptプロジェクトを作成し、必要な依存関係をインストールする。

**対応要件**: 1.2, 5.1

- [x] 1.1 Vite React TypeScriptテンプレートでプロジェクトを初期化し、three.js、@react-three/fiber、@react-three/drei、three-mesh-bvh、jszipをインストールする
- [x] 1.2 基本的なディレクトリ構造（components、services、utils、types、context、hooks）を作成する
- [x] 1.3 Vitestを設定し、サンプルテストが実行できることを確認する

---

### 2. 型定義の作成

アプリケーション全体で使用する型定義を作成する。

**対応要件**: 2.1, 2.2, 2.3, 4.1, 4.2

- [x] 2.1 ボクセル関連の型（Vector3、Color、Voxel、VoxelGrid、VoxelizationOptions）を定義する
- [x] 2.2 Blockbenchモデル形式の型（BlockbenchFace、BlockbenchElement、BlockbenchModel）を定義する
- [x] 2.3 アプリケーション状態の型（AppState、AppAction）を定義する

---

### 3. GLTFローダーユーティリティの実装

GLB/GLTFファイルを読み込み、three.jsのGroupオブジェクトに変換するユーティリティを実装する。

**対応要件**: 1.1

- [x] 3.1 FileオブジェクトからGLB/GLTFをパースするloadFromFile関数を実装する
- [x] 3.2 ファイル形式（拡張子、MIMEタイプ）を検証するvalidateFile関数を実装する
- [x]* 3.3 GLTFローダーのユニットテストを作成する

---

### 4. ボクセル化エンジンの実装

3Dメッシュをボクセルグリッドに変換するコアエンジンを実装する。

**対応要件**: 2.2, 2.3, 6.1, 6.2

- [x] 4.1 MeshProcessorを実装し、GLTFモデルからメッシュを抽出しBVH構造を構築する
- [x] 4.2 GridBuilderを実装し、バウンディングボックスから指定解像度のボクセルグリッド座標を生成する
- [x] 4.3 ColorSamplerを実装し、メッシュ表面の色をテクスチャまたはマテリアルから取得する
- [x] 4.4 VoxelizationEngineを実装し、レイキャストによるメッシュ交差判定と色サンプリングを統合する
- [x]* 4.5 ボクセル化エンジンのユニットテストを作成する

---

### 5. Blockbenchエクスポーターの実装

ボクセルデータをBlockbench形式のJSONとテクスチャに変換するエクスポーターを実装する。

**対応要件**: 4.1, 4.2

- [x] 5.1 TextureGeneratorを実装し、ボクセルの色からテクスチャアトラス画像を生成する
- [x] 5.2 ModelGeneratorを実装し、ボクセル配列をBlockbench elements配列に変換する
- [x] 5.3 BlockbenchExporterを実装し、モデルJSONとテクスチャを統合して出力する
- [x]* 5.4 Blockbenchエクスポーターのユニットテストを作成する

---

### 6. ZIPビルダーとファイルダウンローダーの実装

複数ファイルをZIPにまとめてダウンロードさせるユーティリティを実装する。

**対応要件**: 4.3

- [x] 6.1 ZipBuilderを実装し、JSZipを使用してモデルJSONとテクスチャをZIPアーカイブにまとめる
- [x] 6.2 FileDownloaderを実装し、BlobをダウンロードリンクとしてユーザーにZIPファイルを提供する

---

### 7. 状態管理の実装

React ContextとuseReducerを使用してアプリケーション状態を管理する。

**対応要件**: 1.1, 2.1, 3.2, 5.2

- [x] 7.1 appReducerを実装し、各アクションに対応する状態遷移ロジックを定義する
- [x] 7.2 AppContextとAppProviderを実装し、状態とアクション関数をコンポーネントツリーに提供する

---

### 8. UIコンポーネントの実装

ユーザーインターフェースを構成する各コンポーネントを実装する。

**対応要件**: 1.1, 2.1, 3.1, 3.2, 4.3, 5.1, 5.2

- [x] 8.1 FileUploaderコンポーネントを実装し、ドラッグ&ドロップとファイル選択ダイアログでGLB/GLTFを受け付ける
- [x] 8.2 SettingsPanelコンポーネントを実装し、ボクセル解像度（8-64）をスライダーで調整できるようにする
- [x] 8.3 PreviewCanvasコンポーネントを実装し、@react-three/fiberでボクセル化結果を3D表示する
- [x] 8.4 ExportButtonコンポーネントを実装し、クリックでBlockbench形式ZIPをダウンロードさせる
- [x] 8.5 ProgressIndicatorコンポーネントを実装し、変換処理の進捗をプログレスバーで表示する
- [x] 8.6 ErrorDisplayコンポーネントを実装し、エラーメッセージとリトライボタンを表示する

---

### 9. メインアプリケーションの統合

全コンポーネントを統合し、完全なアプリケーションとして動作するようにする。

**対応要件**: 1.2, 5.1

- [x] 9.1 Layoutコンポーネントを実装し、ヘッダー、サイドパネル、メインキャンバスのレスポンシブレイアウトを構築する
- [x] 9.2 App.tsxで全コンポーネントを統合し、AppProviderでラップしてデータフローを接続する
- [x] 9.3 CSSでレスポンシブデザインを実装し、768px以上の画面幅で適切に表示されるようにする

---

### 10. E2Eテストと最終検証

エンドツーエンドテストを作成し、全要件が満たされていることを確認する。

**対応要件**: 1.1, 1.2, 2.1, 2.2, 2.3, 3.1, 3.2, 4.1, 4.2, 4.3, 5.1, 5.2, 6.1, 6.2

- [x] 10.1 GLB/GLTFファイルの読み込みから、ボクセル化、プレビュー表示、ZIPダウンロードまでの一連のフローをテストする
- [x] 10.2 エラーケース（不正ファイル、大規模モデル）のハンドリングをテストする
- [ ] 10.3 出力されたZIPファイルをBlockbenchで開き、正しく表示されることを手動確認する

---

## 要件カバレッジマトリクス

| 要件ID | 要件名 | 対応タスク |
|--------|--------|-----------|
| 1.1 | GLB/GLTFファイル読み込み | 3.1, 3.2, 7.2, 8.1 |
| 1.2 | サーバーレス処理 | 1.1, 9.2 |
| 2.1 | ボクセル解像度設定 | 2.1, 7.2, 8.2 |
| 2.2 | テクスチャからの色抽出 | 2.1, 4.3 |
| 2.3 | ジオメトリのボクセル化 | 2.1, 4.1, 4.2, 4.4 |
| 3.1 | 3Dプレビュー表示 | 8.3 |
| 3.2 | リアルタイムパラメータ調整 | 7.1, 8.2 |
| 4.1 | Blockbench形式出力 | 2.2, 5.2, 5.3 |
| 4.2 | テクスチャ出力 | 2.2, 5.1, 5.3 |
| 4.3 | ファイルダウンロード | 6.1, 6.2, 8.4 |
| 5.1 | レスポンシブデザイン | 1.1, 9.1, 9.3 |
| 5.2 | エラーハンドリング | 7.1, 8.6 |
| 6.1 | 変換速度 | 4.1, 4.4 |
| 6.2 | メモリ使用量 | 4.4 |

---

## 実装順序の推奨

```
1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 9 → 10
     │
     └── 型定義は全タスクの基盤となる
```

**クリティカルパス**: 1 → 2 → 4 → 5 → 8 → 9

**依存関係**:
- タスク3, 4, 5, 6はタスク2（型定義）に依存
- タスク7, 8はタスク3, 4, 5, 6の完了に依存
- タスク9はタスク7, 8の完了に依存
- タスク10はタスク9の完了に依存
